import{_ as s,v as n,b as e,R as o}from"./chunks/framework.caa0fbaf.js";const D=JSON.parse('{"title":"reproduction-vitepress-vite-unocss-build-forever","description":"","frontmatter":{},"headers":[],"relativePath":"README.md","filePath":"README.md"}'),a={name:"README.md"},l=o(`<h1 id="reproduction-vitepress-vite-unocss-build-forever" tabindex="-1">reproduction-vitepress-vite-unocss-build-forever <a class="header-anchor" href="#reproduction-vitepress-vite-unocss-build-forever" aria-label="Permalink to &quot;reproduction-vitepress-vite-unocss-build-forever&quot;">​</a></h1><p>This is a reproduction repo for a bug I found when using VitePress.</p><p>When the following content appears in Markdown document and try to browse and build with VitePress that configures UnoCSS and Vite:</p><div class="language-markdown"><button title="Copy Code" class="copy"></button><span class="lang">markdown</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#89DDFF;">[</span><span style="color:#C3E88D;">https://example.com/documentation/</span><span style="color:#89DDFF;">](</span><span style="color:#F07178;text-decoration:underline;">https://example.com/documentation/</span><span style="color:#89DDFF;">)</span></span></code></pre></div><p>and the following issues occur:</p><ol><li><p>After executed <code>pnpm docs:dev</code> or (<code>nr docs:dev</code>) command, the development server is running without any complaints and the bugged page is rendered correctly when navigate to, the server hangs and would be stuck once and only when you try to navigate back to the other pages.</p></li><li><p>After executed <code>pnpm docs:dev</code> or (<code>nr docs:dev</code>) command, the building rotating indicator before <code>building client + server bundles...</code> would stop to rotate after a few seconds, and this will eventually result in never ending build process that stuck forever. The shell looks like this:</p></li></ol><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">nr</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">docs:build</span></span>
<span class="line"></span>
<span class="line"><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> @ docs:build </span><span style="color:#89DDFF;">~</span><span style="color:#A6ACCD;">/Git/reproduction-vitepress-vite-unocss-build-forever</span></span>
<span class="line"><span style="color:#89DDFF;">&gt;</span><span style="color:#A6ACCD;"> vitepress build</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#A6ACCD;">  </span><span style="color:#FFCB6B;">vitepress</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">v1.0.0-beta.7</span></span>
<span class="line"></span>
<span class="line"><span style="color:#FFCB6B;">⠙</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">building</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">client</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">+</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">server</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">bundles...</span></span></code></pre></div><p>After few minutes, the shell may suddenly prompt <code>[vite:esbuild-transpile] The service was stopped: write EPIPE</code> error even when you have interrupted the build process already.</p><h2 id="troubleshooting" tabindex="-1">Troubleshooting <a class="header-anchor" href="#troubleshooting" aria-label="Permalink to &quot;Troubleshooting&quot;">​</a></h2><ul><li>I tried to check the content above, nor invisible and control characters found.</li><li>Tried to update all the dependencies.</li><li>Tried to disable every plugin I used in Vite, I found that the issue is caused by the <code>unocss</code> plugin only when <code>presetUno()</code> UnoCSS plugin was enabled.</li><li>It looks like the url content must have a valid and resolvable host, otherwise the issue won&#39;t occur. (FYI, the initial url that caused the issue was <code>https://www.swift.org/documentation/</code>)</li></ul><h2 id="further-more" tabindex="-1">Further more <a class="header-anchor" href="#further-more" aria-label="Permalink to &quot;Further more&quot;">​</a></h2><p>Another thing is, I think either Vite or esbuild should have a better way to handle the timeout issue when building forever and deal with the child process to prevent defunct process. Otherwise, if user keep retry and interrupt the build process, the defunct process will keep increasing and cause the system to stay on high load with loads of defunct processes that consume 100% CPU and memory.</p><h3 id="defunct-process-issue" tabindex="-1">defunct process issue <a class="header-anchor" href="#defunct-process-issue" aria-label="Permalink to &quot;defunct process issue&quot;">​</a></h3><p>After executed <code>pnpm docs:build</code> or (<code>nr docs:build</code>) command, the process tree looks like this:</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">❯</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">pstree</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">09115</span></span>
<span class="line"><span style="color:#A6ACCD;">-</span><span style="color:#89DDFF;">+=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">09115</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">neko</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/bin/zsh</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-il</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;">-</span><span style="color:#89DDFF;">+=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">12787</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">neko</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">node</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">~/Library/pnpm/global/5/node_modules/@antfu/ni/bin/nr.mjs</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">docs:build</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">\\-+-</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">12793</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">neko</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">node</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">~/Library/pnpm/global/5/node_modules/@antfu/ni/bin/nr.mjs</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">docs:build</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;">   </span><span style="color:#FFCB6B;">\\-+-</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">12817</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">neko</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/opt/homebrew/Cellar/volta/1.1.1_2/libexec/bin/volta</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">run</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">pnpm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">run</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">docs:build</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;">     </span><span style="color:#FFCB6B;">\\-+-</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">12818</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">neko</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">node</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">~/.volta/tools/image/packages/pnpm/bin/pnpm</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">run</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">docs:build</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;">       </span><span style="color:#FFCB6B;">\\-+-</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">12837</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">neko</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">node</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">~/Git/reproduction-vitepress-vite-unocss-build-forever/node_modules/.bin/../vitepress/bin/vitepress.js</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">build</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">|</span><span style="color:#A6ACCD;">         </span><span style="color:#FFCB6B;">\\---</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">12843</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">neko</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">~/Git/reproduction-vitepress-vite-unocss-build-forever/node_modules/.pnpm/@esbuild+darwin-arm64@0.18.18/node_modules/@esbuild/darwin-arm64/bin/esbuild</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--service=0.18.18</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">--ping</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">\\--</span><span style="color:#A6ACCD;">= </span><span style="color:#F78C6C;">09722</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">neko</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/bin/zsh</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-il</span></span></code></pre></div><p>Then use Ctrl-C to interrupt the build process, and the process tree for the same zsh shell pid <code>09115</code> looks like this afterwards:</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">❯</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">pstree</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">09115</span></span>
<span class="line"><span style="color:#A6ACCD;">-</span><span style="color:#89DDFF;">+=</span><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">09115</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">neko</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/bin/zsh</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-il</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">\\--</span><span style="color:#A6ACCD;">= </span><span style="color:#F78C6C;">09722</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">neko</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">/bin/zsh</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">-il</span></span></code></pre></div><p>You may notice this process tree is now empty, but the process tree for the VitePress build process pid <code>12837</code> is still there with a defunct child process:</p><div class="language-shell"><button title="Copy Code" class="copy"></button><span class="lang">shell</span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#FFCB6B;">❯</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">pstree</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">12837</span></span>
<span class="line"><span style="color:#FFCB6B;">-+-</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">12837</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">neko</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">node</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">~/Git/reproduction-vitepress-vite-unocss-build-forever/node_modules/.bin/../vitepress/bin/vitepress.js</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">build</span></span>
<span class="line"><span style="color:#A6ACCD;"> </span><span style="color:#FFCB6B;">\\---</span><span style="color:#A6ACCD;"> </span><span style="color:#F78C6C;">12843</span><span style="color:#A6ACCD;"> </span><span style="color:#C3E88D;">neko</span><span style="color:#A6ACCD;"> </span><span style="color:#89DDFF;">&lt;</span><span style="color:#C3E88D;">defunc</span><span style="color:#A6ACCD;">t</span><span style="color:#89DDFF;">&gt;</span></span></code></pre></div>`,19),p=[l];function t(r,c,i,C,d,y){return n(),e("div",null,p)}const u=s(a,[["render",t]]);export{D as __pageData,u as default};
